<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“˜ Registro Medie</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 20px;
      color: #111;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .subjects {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
    }
    .subject-btn {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #f9fafb;
    }
    .subject-btn.active {
      background: #6366f1;
      color: white;
      border-color: #4f46e5;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 8px;
      text-align: center;
    }
    input[type="number"] {
      width: 60px;
      padding: 4px;
      text-align: center;
    }
    .bar {
      height: 8px;
      border-radius: 4px;
      background: #e5e7eb;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      transition: width 0.3s;
    }
    .bar-fill.red { background: #ef4444; }
    .bar-fill.green { background: #22c55e; }
    .note {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      margin: 5px;
      font-size: 14px;
      color: white;
    }
    .disciplinare { background: #ef4444; }
    .didattica { background: #3b82f6; }
    .note button {
      margin-left: 6px;
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
    }
    .condotta {
      font-size: 24px;
      font-weight: bold;
      color: #111;
    }
  </style>
</head>
<body>
  <h1>ðŸ“˜ Registro Medie</h1>

  <!-- Materie -->
  <div class="card">
    <h2>Materie</h2>
    <div class="subjects" id="subjects"></div>
  </div>

  <!-- Voti -->
  <div class="card">
    <h2>Voti</h2>
    <table id="gradesTable">
      <thead>
        <tr><th>Materia</th><th>1Â° Quad.</th><th>2Â° Quad.</th><th>Media</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Note -->
  <div class="card">
    <h2>Note</h2>
    <input type="text" id="noteText" placeholder="Scrivi una nota">
    <select id="noteType">
      <option value="disciplinare">Disciplinare</option>
      <option value="didattica">Didattica</option>
    </select>
    <button onclick="addNote()">Aggiungi</button>
    <div id="notes"></div>
  </div>

  <!-- Riepilogo -->
  <div class="card">
    <h2>Riepilogo</h2>
    <p class="condotta">Condotta: <span id="conduct">10</span></p>
    <p>Media generale: <span id="avg">-</span></p>
  </div>

  <script>
    const SUBJECTS = [
      "Italiano","Storia","Geografia","Matematica","Scienze","Inglese","Francese","Spagnolo","Tedesco","Arte","Musica","Tecnologia","Scienze Motorie","Religione"
    ];

    let state = JSON.parse(localStorage.getItem("registro_html")) || {
      subjects: [],
      grades: {},
      notes: []
    };

    const subjectsDiv = document.getElementById("subjects");
    const tableBody = document.querySelector("#gradesTable tbody");
    const notesDiv = document.getElementById("notes");

    function save() {
      localStorage.setItem("registro_html", JSON.stringify(state));
      render();
    }

    function toggleSubject(s) {
      if (state.subjects.includes(s)) {
        state.subjects = state.subjects.filter(x => x !== s);
      } else {
        state.subjects.push(s);
      }
      save();
    }

    function setGrade(s, q, val) {
      if (!state.grades[s]) state.grades[s] = { q1: "", q2: "" };
      state.grades[s][q] = val;
      save();
    }

    function addNote() {
      const text = document.getElementById("noteText").value.trim();
      const type = document.getElementById("noteType").value;
      if (!text) return;
      state.notes.push({ id: Date.now(), text, type });
      document.getElementById("noteText").value = "";
      save();
    }

    function deleteNote(id) {
      state.notes = state.notes.filter(n => n.id !== id);
      save();
    }

    function avg(arr) {
      return arr.length ? (arr.reduce((a,b) => a+b,0)/arr.length).toFixed(2) : "-";
    }

    function conduct() {
      let base = 10;
      const discNotes = state.notes.filter(n => n.type === "disciplinare").length;
      base -= discNotes * 0.5;
      return Math.max(1, base.toFixed(2));
    }

    function render() {
      // materie
      subjectsDiv.innerHTML = "";
      SUBJECTS.forEach(s => {
        const btn = document.createElement("div");
        btn.className = "subject-btn" + (state.subjects.includes(s) ? " active" : "");
        btn.innerText = s;
        btn.onclick = () => toggleSubject(s);
        subjectsDiv.appendChild(btn);
      });

      // voti
      tableBody.innerHTML = "";
      state.subjects.forEach(s => {
        const g = state.grades[s] || { q1:"", q2:"" };
        const media = g.q1 && g.q2 ? ((+g.q1 + +g.q2)/2).toFixed(2) : "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s}</td>
          <td><input type="number" min="1" max="10" value="${g.q1}" onchange="setGrade('${s}','q1',this.value)"></td>
          <td><input type="number" min="1" max="10" value="${g.q2}" onchange="setGrade('${s}','q2',this.value)"></td>
          <td>
            ${media}
            <div class="bar">
              <div class="bar-fill ${media !== "-" && media < 6 ? "red" : "green"}" style="width:${media === "-" ? 0 : media*10}%;"></div>
            </div>
          </td>
        `;
        tableBody.appendChild(tr);
      });

      // note
      notesDiv.innerHTML = "";
      state.notes.forEach(n => {
        const span = document.createElement("span");
        span.className = "note " + n.type;
        span.innerHTML = `${n.text} <button onclick="deleteNote(${n.id})">âœ•</button>`;
        notesDiv.appendChild(span);
      });

      // riepilogo
      document.getElementById("conduct").innerText = conduct();
      const medias = state.subjects.map(s => {
        const g = state.grades[s] || {};
        if (!g.q1 || !g.q2) return null;
        return (+g.q1 + +g.q2)/2;
      }).filter(x => x);
      document.getElementById("avg").innerText = avg(medias);
    }

    render();
  </script>
</body>
</html>
